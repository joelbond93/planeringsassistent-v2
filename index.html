<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Planeringsassistent</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<!-- HEADER -->
<header id="header">
  <h1>Planeringsassistent</h1>

  <div id="active-theme">
    <span id="active-theme-label">Tema</span>
    <span id="active-theme-value">Inget valt</span>
  </div>
</header>

<!-- TEMA-KNAPPAR -->
<div id="theme-selector" class="theme-buttons">
  <button data-theme="travel">Resor</button>
  <button data-theme="activities">Aktiviteter</button>
  <button data-theme="food">Mat</button>
  <button data-theme="projects">Projekt</button>
  <button data-theme="custom">Eget</button>
  <input id="customThemeInput" type="text" placeholder="Skriv eget tema‚Ä¶" style="display:none;" />
</div>

<!-- START -->
<section id="start-screen">
  <div class="start-cards" id="startIdeas"></div>
  <p class="start-or">eller skriv sj√§lv</p>

  <div class="start-input">
    <input id="startInput" placeholder="Vad vill du planera?" />
    <button onclick="startFromInput()">Starta</button>
  </div>
</section>

<!-- CHAT -->
<section id="chat-container" hidden>
  <div id="messages">
    <div class="chat-spacer"></div>
  </div>

  <div id="bottom-area">
    <div id="buttons"></div>

    <div id="input-area">
      <input id="userInput" placeholder="Skriv h√§r‚Ä¶" />
      <button onclick="sendMessage()">Skicka</button>
      <button onclick="resetConversation()">Nollst√§ll</button>
    </div>
  </div>
</section>

<script>
/* =====================
   STATE
===================== */
let conversation = [];
let lockedTheme = null;

const messagesDiv = document.getElementById("messages");
const buttonsDiv = document.getElementById("buttons");
const userInput = document.getElementById("userInput");

/* =====================
   THEME LABELS
===================== */
const THEME_LABELS = {
  travel: "Resor",
  activities: "Aktiviteter",
  food: "Mat",
  projects: "Projekt"
};

/* =====================
   START TOPICS (POOLER)
===================== */
const START_TOPICS = {
  travel: [
    "Planera en resa i Europa",
    "Hitta ett bra resm√•l f√∂r kort semester",
    "Resa med liten budget",
    "Packlista f√∂r resa",
    "Resa med barn",
    "Spontan weekendresa",
    "L√•ngresa ‚Äì hur b√∂rjar man?",
    "Resa ensam"
  ],

  food: [
    "Planera en middag",
    "Vad ska vi √§ta i veckan?",
    "Mat till m√•nga personer",
    "Enkel men festlig mat",
    "Vegetarisk middag",
    "Snabb vardagsmat",
    "Planera meny till helg",
    "Vad kan jag laga av det jag har hemma?"
  ],

  activities: [
    "Hitta p√• n√•got kul i helgen",
    "Aktivitet med v√§nner",
    "N√•got spontant att g√∂ra",
    "Inomhusaktivitet",
    "Utomhusaktivitet",
    "Billig aktivitet",
    "N√•got kreativt",
    "N√•got avslappnat"
  ],

  projects: [
    "Strukturera en id√©",
    "Planera ett projekt",
    "Komma vidare i ett projekt",
    "Bryta ner en stor uppgift",
    "S√§tta m√•l och n√§sta steg",
    "Planera tidslinje",
    "Prioritera bland id√©er",
    "F√• ordning p√• ett sidoprojekt"
  ],

  default: [
    "Jag vill planera n√•got",
    "Hj√§lp mig strukturera en id√©",
    "Jag vet inte riktigt var jag ska b√∂rja",
    "Jag beh√∂ver inspiration",
    "Hj√§lp mig t√§nka klart",
    "Jag vill komma vidare med n√•got"
  ]
};

/* =====================
   HELPERS
===================== */
function pickRandomItems(arr, count) {
  return arr
    .slice()
    .sort(() => Math.random() - 0.5)
    .slice(0, count);
}

/* =====================
   START IDEAS RENDER
===================== */
function renderStartIdeas() {
  const container = document.getElementById("startIdeas");
  container.innerHTML = "";

  const pool =
    lockedTheme && START_TOPICS[lockedTheme]
      ? START_TOPICS[lockedTheme]
      : START_TOPICS.default;

  const topics = pickRandomItems(pool, 3);

  topics.forEach(text => {
    const btn = document.createElement("button");

    btn.innerHTML = `
      <strong>${text}</strong>
    `;

    btn.onclick = () => startConversation(text);
    container.appendChild(btn);
  });
}

/* =====================
   START FLOW
===================== */
function startFromInput() {
  const v = document.getElementById("startInput").value.trim();
  if (v) startConversation(v);
}

function startConversation(text) {
  document.getElementById("start-screen").hidden = true;
  document.getElementById("chat-container").hidden = false;
  sendMessage(text);
}

/* =====================
   THEME HANDLING
===================== */
function updateThemeUI() {
  const label =
    lockedTheme && THEME_LABELS[lockedTheme]
      ? THEME_LABELS[lockedTheme]
      : lockedTheme || "Inget valt";

  document.getElementById("active-theme-value").textContent = label;
  document.body.className = lockedTheme ? `theme-${lockedTheme}` : "";

  document.querySelectorAll(".theme-buttons button").forEach(b => {
    b.classList.toggle("active", b.dataset.theme === lockedTheme);
  });

  renderStartIdeas(); // üëà VIKTIG
}

document.querySelectorAll(".theme-buttons button").forEach(btn => {
  btn.onclick = () => {
    const theme = btn.dataset.theme;
    const input = document.getElementById("customThemeInput");

    if (theme === "custom") {
      lockedTheme = null;
      input.style.display = "inline-block";
      input.focus();
    } else {
      lockedTheme = theme;
      input.style.display = "none";
    }

    updateThemeUI();
  };
});

document.getElementById("customThemeInput").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    lockedTheme = e.target.value.trim();
    e.target.blur();
    updateThemeUI();
  }
});

/* =====================
   CHAT UI
===================== */
function addMessage(text, sender) {
  const d = document.createElement("div");
  d.className = `message ${sender}`;
  d.textContent = text;
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* =====================
   SEND MESSAGE
===================== */
async function sendMessage(override = null) {
  const text = override || userInput.value.trim();
  if (!text) return;

  addMessage(text, "user");
  userInput.value = "";
  buttonsDiv.innerHTML = "";

  addMessage("AI t√§nker‚Ä¶", "assistant thinking");

  conversation.push({
    role: "user",
    content: lockedTheme ? `[Tema: ${lockedTheme}] ${text}` : text
  });

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: conversation.slice(-8) })
    });

    const data = await res.json();
    messagesDiv.lastChild.remove();
    handleAIResponse(data.message || "");
  } catch {
    messagesDiv.lastChild.remove();
    addMessage("N√•got gick fel.", "assistant");
  }
}

/* =====================
   AI RESPONSE
===================== */
function handleAIResponse(raw) {
  const split = raw.indexOf("Knapp:");
  const text = split !== -1 ? raw.slice(0, split) : raw;
  const btnPart = split !== -1 ? raw.slice(split) : "";

  addMessage(text.trim(), "assistant");

  (btnPart.match(/Knapp:\s*([^;]+);/g) || [])
    .slice(0, 4)
    .forEach((m, i) => {
      const t = m.replace("Knapp:", "").replace(/[";]/g, "").trim();
      const b = document.createElement("button");
      b.textContent = `${i + 1}. ${t}`;
      b.dataset.index = i;
      b.onclick = () => sendMessage(t);
      buttonsDiv.appendChild(b);
    });
}

/* =====================
   RESET
===================== */
function resetConversation() {
  conversation = [];
  lockedTheme = null;

  messagesDiv.innerHTML = "";
  buttonsDiv.innerHTML = "";

  document.getElementById("chat-container").hidden = true;
  document.getElementById("start-screen").hidden = false;

  updateThemeUI();
  renderStartIdeas();
}

/* =====================
   KEYBOARD QoL
===================== */
document.addEventListener("keydown", e => {
  if (e.key === "Enter" && document.activeElement === userInput) {
    sendMessage();
    e.preventDefault();
  }

  if (["1","2","3","4"].includes(e.key) && document.activeElement !== userInput) {
    const btn = buttonsDiv.querySelector(
      `button[data-index="${parseInt(e.key) - 1}"]`
    );
    if (btn) btn.click();
  }
});

/* =====================
   INIT
===================== */
renderStartIdeas();
updateThemeUI();
</script>


</body>
</html>
