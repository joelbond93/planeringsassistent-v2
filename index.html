<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />

  <!-- Viewport: lÃ¥ser zoom och ger app-kÃ¤nsla -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />

  <!-- iOS: tillÃ¥t app-liknande beteende -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>Planeringsassistent</title>

  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header id="header">
  <h1>Planeringsassistent</h1>

  <div id="active-theme">
  <strong id="active-theme-value">Inget valt</strong>
</div>
</header>

<div id="theme-selector" class="theme-buttons">
  <button data-theme="travel">Resor</button>
  <button data-theme="activities">Aktiviteter</button>
  <button data-theme="food">Mat</button>
  <button data-theme="projects">Projekt</button>
  <button data-theme="custom">Eget</button>
  <input id="customThemeInput" placeholder="Skriv eget temaâ€¦" />
</div>

<main id="main">

  <!-- START -->
  <section id="start-screen">
    <div class="start-cards" id="startIdeas"></div>
    <p class="start-or">eller skriv sjÃ¤lv</p>

    <div class="start-input">
      <input id="startInput" placeholder="Vad vill du planera?" />
      <button id="startButton">Starta</button>
    </div>
    <p class="ai-disclaimer">
  Svaren genereras automatiskt av AI och Ã¤r tÃ¤nkta som stÃ¶d, inte facit.
</p>
  </section>


  <!-- CHAT -->
<section id="chat-container" hidden>
  <div id="messages"></div>

  <div id="bottom-area">
    <div id="buttons"></div>

    <div id="input-area">
      <input id="userInput" placeholder="Skriv hÃ¤râ€¦" />
      <button onclick="sendMessage()">Skicka</button>
      <button onclick="resetConversation()">NollstÃ¤ll</button>
    </div>
  </div>
</section>


</main>

<script>
/* =====================
   STATE
===================== */
let conversation = [];
let lockedTheme = null;
let customThemeLabel = "";     // (som vi redan identifierat)
let customStartCards = null;  // ğŸ‘ˆ HÃ„R

const messagesDiv = document.getElementById("messages");
const buttonsDiv = document.getElementById("buttons");

const customThemeInput = document.getElementById("customThemeInput"); // ğŸ‘ˆ HÃ„R

/* =====================
   THEME LABELS
===================== */
const THEME_LABELS = {
  travel: "Resor",
  activities: "Aktiviteter",
  food: "Mat",
  projects: "Projekt"
};

/* =====================
   START TOPICS
===================== */
const START_TOPICS = {
  travel: {
    quick: "Planera en resa",
    open: "Jag vill resa men vet inte vart",
    specific: "Resa utan datum eller budget"
  },
  food: {
    quick: "Planera en middag",
    open: "Vad ska vi Ã¤ta?",
    specific: "Meny fÃ¶r flera dagar"
  },
  activities: {
    quick: "Hitta pÃ¥ nÃ¥got kul",
    open: "Jag vill gÃ¶ra nÃ¥got men vet inte vad",
    specific: "Aktivitet i helgen"
  },
  projects: {
    quick: "Strukturera en idÃ©",
    open: "Jag har fÃ¶r mÃ¥nga lÃ¶sa trÃ¥dar",
    specific: "NÃ¤sta steg i ett projekt"
  },
  default: {
    quick: "Jag vill planera nÃ¥got",
    open: "HjÃ¤lp mig tÃ¤nka",
    specific: "Ta fram nÃ¤sta rimliga steg"
  }
};

// function pickRandom(arr, n) {
//   return arr.sort(() => Math.random() - 0.5).slice(0, n);
// }

/* =====================
   START RENDER
===================== */
function renderStartIdeas() {
  const c = document.getElementById("startIdeas");
  c.innerHTML = "";

  let cards;

  if (lockedTheme === "custom") {
    if (customStartCards === "loading") {
      cards = [
        "Skapar fÃ¶rslagâ€¦",
        "TÃ¤nker pÃ¥ mÃ¶jliga ingÃ¥ngarâ€¦",
        "FÃ¶rbereder nÃ¤sta stegâ€¦"
      ];
    } else if (Array.isArray(customStartCards)) {
      cards = customStartCards;
    } else {
      const topics = START_TOPICS.default;
      cards = [topics.quick, topics.open, topics.specific];
    }
  } else {
    const topics = START_TOPICS[lockedTheme] || START_TOPICS.default;
    cards = [topics.quick, topics.open, topics.specific];
  }

  cards.forEach(text => {
    const b = document.createElement("button");
    b.innerHTML = `<strong>${text}</strong>`;

    // â›” disable klick under loading
    if (customStartCards === "loading") {
      b.disabled = true;
      b.style.opacity = "0.55";
      b.style.cursor = "default";
    } else {
      b.onclick = () => startConversation(text);
    }

    c.appendChild(b);
  });
}

/* =====================
   CUSTOM START CARDS (AI)
===================== */
async function generateCustomStartCards(theme) {
  const prompt = `
Skapa tre korta startfÃ¶rslag fÃ¶r planering inom temat: "${theme}".

Roller:
1. Snabb start
2. Ã–ppen tanke
3. Mer riktad ingÃ¥ng

Regler:
- 4â€“8 ord per fÃ¶rslag
- inga frÃ¥gor
- neutralt och lugnt sprÃ¥k
- inga emojis

Returnera exakt tre rader, utan extra text.
`;

  const res = await fetch("/api/custom-start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const data = await res.json();

  if (!Array.isArray(data.cards) || data.cards.length !== 3) {
    throw new Error("Invalid custom cards response");
  }

  return data.cards;
}

/* =====================
   START FLOW
===================== */
function startConversation(text) {
  document.getElementById("start-screen").hidden = true;
  document.getElementById("chat-container").hidden = false;
  sendMessage(text);
}
function startFromInput() {
  const input = document.getElementById("startInput");
  if (!input) return;

  const value = input.value.trim();
  if (!value) return;

  startConversation(value);
}

/* =====================
   THEME
===================== */
function updateThemeUI() {
  let label = "Inget tema valt";

  if (lockedTheme === "custom") {
    label = customThemeLabel || "Eget tema";
  } else if (lockedTheme && THEME_LABELS[lockedTheme]) {
    label = THEME_LABELS[lockedTheme];
  }

  document.getElementById("active-theme-value").textContent = label;

  document.body.className = lockedTheme ? `theme-${lockedTheme}` : "";

  document.querySelectorAll(".theme-buttons button").forEach(b => {
    b.classList.toggle("active", b.dataset.theme === lockedTheme);
  });
}

document.querySelectorAll(".theme-buttons button").forEach(btn => {
  btn.onclick = () => {
    const theme = btn.dataset.theme;

    // Toggle OFF om samma tema klickas igen
    if (lockedTheme === theme) {
      lockedTheme = null;
      customThemeLabel = "";
      customThemeInput.style.display = "none";
    } else {
      if (theme === "custom") {
        lockedTheme = "custom";
        customThemeInput.style.display = "inline-block";
        customThemeInput.focus();
        return; // vÃ¤nta pÃ¥ input
      } else {
        lockedTheme = theme;
        customThemeInput.style.display = "none";
      }
    }

    updateThemeUI();
    renderStartIdeas();
  };
});

document.getElementById("customThemeInput").addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;

  // ğŸ›‘ skydd mot dubbel-trigger medan AI jobbar
  if (customStartCards === "loading") return;

  const value = e.target.value.trim();
  if (!value) return;

  lockedTheme = "custom";
  customThemeLabel = value;
  customStartCards = "loading"; // ğŸ‘ˆ markerar pÃ¥gÃ¥ende AI-jobb

  e.target.blur();
  updateThemeUI();
  renderStartIdeas(); // (kan visa placeholders senare)

  try {
    customStartCards = await generateCustomStartCards(value);
  } catch (err) {
    console.warn("Custom start cards failed", err);
    customStartCards = null;
  }

  renderStartIdeas(); // âœ… rendera igen nÃ¤r klart
});



/* =====================
   CHAT
===================== */
function addMessage(text, sender) {
  const d = document.createElement("div");
  d.className = `message ${sender}`;
  const linked = text.replace(
  /(https:\/\/[^\s]+)/g,
  '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
);

  d.innerHTML = linked;
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage(override = null) {
  const text = override || userInput.value.trim();
  if (!text) return;

  addMessage(text, "user");
  userInput.value = "";
  buttonsDiv.innerHTML = "";
  buttonsDiv.style.visibility = "hidden";

  addMessage("AI tÃ¤nkerâ€¦", "assistant thinking");

conversation.push({
  role: "user",
  content:
    lockedTheme === "custom"
      ? `[Tema: ${customThemeLabel}] ${text}`
      : lockedTheme
        ? `[Tema: ${lockedTheme}] ${text}`
        : text
});

  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages: conversation.slice(-8) })
  });

  const data = await res.json();
  messagesDiv.lastChild.remove();
  handleAIResponse(data.message || "");
}

function handleAIResponse(raw) {
  buttonsDiv.style.visibility = "visible"; // ğŸ‘ˆ VIKTIG RAD

  const split = raw.indexOf("Knapp:");
  const text = split !== -1 ? raw.slice(0, split) : raw;
  const btns = (raw.match(/Knapp:\s*([^;]+);/g) || []).slice(0, 4);

  addMessage(text.trim(), "assistant");

  btns.forEach((b, i) => {
    const t = b.replace("Knapp:", "").replace(/[";]/g, "").trim();
    const btn = document.createElement("button");
    btn.textContent = `${i + 1}. ${t}`;
    btn.onclick = () => sendMessage(t);
    buttonsDiv.appendChild(btn);
  });
}

/* =====================
   RESET
===================== */
function resetConversation() {
  conversation = [];
  lockedTheme = null;
  customThemeLabel = "";
  customStartCards = null; // ğŸ‘ˆ lÃ¤gg till
  updateThemeUI();

  messagesDiv.innerHTML = "";
  buttonsDiv.innerHTML = "";
  buttonsDiv.style.visibility = "hidden";
  userInput.value = "";

  document.getElementById("chat-container").hidden = true;
  document.getElementById("start-screen").hidden = false;

  renderStartIdeas();
}

/* =====================
   START INPUT â€“ ENTER
===================== */

const startInput = document.getElementById("startInput");
const startButton = document.getElementById("startButton");

// Klick pÃ¥ Starta
if (startButton) {
  startButton.addEventListener("click", e => {
    e.preventDefault();
    startFromInput();
  });
}

// Enter i start-input
if (startInput) {
  startInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      startFromInput();
    }
  });
}
/* =====================
   INIT
===================== */
renderStartIdeas();
updateThemeUI();

document.addEventListener("keydown", e => {
  // Enter skickar meddelande
  if (e.key === "Enter" && document.activeElement === userInput) {
    e.preventDefault();
    sendMessage();
    return;
  }

  // 1â€“4 vÃ¤ljer svarsknappar
  if (["1","2","3","4"].includes(e.key) && document.activeElement !== userInput) {
    const index = parseInt(e.key, 10) - 1;
    const btn = buttonsDiv.querySelector(`button:nth-child(${index + 1})`);
    if (btn) {
      btn.click();
      e.preventDefault();
    }
  }
});

const userInput = document.getElementById("userInput");

if (userInput && window.visualViewport) {
  let lastViewportHeight = window.visualViewport.height;

  window.visualViewport.addEventListener("resize", () => {
    const currentHeight = window.visualViewport.height;

    // Om viewport-hÃ¶jden minskar â†’ tangentbord Ã¶ppnas
    if (currentHeight < lastViewportHeight) {
      userInput.scrollIntoView({
        behavior: "smooth",
        block: "center"
      });
    }

    lastViewportHeight = currentHeight;
  });
}


</script>

</body>
</html>
