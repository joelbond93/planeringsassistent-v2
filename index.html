<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Planeringsassistent</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header id="header">
  <h1>Planeringsassistent</h1>

  <div id="active-theme">
    <span>Tema</span>
    <strong id="active-theme-value">Inget valt</strong>
  </div>
</header>

<div id="theme-selector" class="theme-buttons">
  <button data-theme="travel">Resor</button>
  <button data-theme="activities">Aktiviteter</button>
  <button data-theme="food">Mat</button>
  <button data-theme="projects">Projekt</button>
  <button data-theme="custom">Eget</button>
  <input id="customThemeInput" placeholder="Skriv eget tema…" />
</div>

<main id="main">

  <!-- START -->
  <section id="start-screen">
    <div class="start-cards" id="startIdeas"></div>
    <p class="start-or">eller skriv själv</p>

    <div class="start-input">
      <input id="startInput" placeholder="Vad vill du planera?" />
      <button id="startButton">Starta</button>
    </div>
  </section>


  <!-- CHAT -->
<section id="chat-container" hidden>
  <div id="messages"></div>

  <div id="bottom-area">
    <div id="buttons"></div>

    <div id="input-area">
      <input id="userInput" placeholder="Skriv här…" />
      <button onclick="sendMessage()">Skicka</button>
      <button onclick="resetConversation()">Nollställ</button>
    </div>
  </div>
</section>


</main>

<script>
/* =====================
   STATE
===================== */
let conversation = [];
let lockedTheme = null;

const messagesDiv = document.getElementById("messages");
const buttonsDiv = document.getElementById("buttons");
const userInput = document.getElementById("userInput");

/* =====================
   THEME LABELS
===================== */
const THEME_LABELS = {
  travel: "Resor",
  activities: "Aktiviteter",
  food: "Mat",
  projects: "Projekt"
};

/* =====================
   START TOPICS
===================== */
const START_TOPICS = {
  travel: ["Planera en resa", "Weekendresa", "Resa på budget"],
  food: ["Planera en middag", "Vad ska vi äta?", "Meny till helg"],
  activities: ["Hitta på något kul", "Aktivitet i helgen", "Spontan idé"],
  projects: ["Strukturera en idé", "Planera projekt", "Nästa steg"],
  default: ["Jag vill planera något", "Hjälp mig tänka", "Jag behöver struktur"]
};

function pickRandom(arr, n) {
  return arr.sort(() => Math.random() - 0.5).slice(0, n);
}

/* =====================
   START RENDER
===================== */
function renderStartIdeas() {
  const c = document.getElementById("startIdeas");
  c.innerHTML = "";

  const pool = START_TOPICS[lockedTheme] || START_TOPICS.default;
  pickRandom(pool, 3).forEach(text => {
    const b = document.createElement("button");
    b.innerHTML = `<strong>${text}</strong>`;
    b.onclick = () => startConversation(text);
    c.appendChild(b);
  });
}

/* =====================
   START FLOW
===================== */
function startConversation(text) {
  document.getElementById("start-screen").hidden = true;
  document.getElementById("chat-container").hidden = false;
  sendMessage(text);
}
function startFromInput() {
  const input = document.getElementById("startInput");
  if (!input) return;

  const value = input.value.trim();
  if (!value) return;

  startConversation(value);
}

/* =====================
   THEME
===================== */
function updateThemeUI() {
  let label = "Inget valt";

  if (lockedTheme === "custom") {
    label = customThemeLabel || "Eget tema";
  } else if (lockedTheme && THEME_LABELS[lockedTheme]) {
    label = THEME_LABELS[lockedTheme];
  }

  document.getElementById("active-theme-value").textContent = label;

  document.body.className = lockedTheme ? `theme-${lockedTheme}` : "";

  document.querySelectorAll(".theme-buttons button").forEach(b => {
    b.classList.toggle("active", b.dataset.theme === lockedTheme);
  });
}

document.querySelectorAll(".theme-buttons button").forEach(btn => {
  btn.onclick = () => {
    if (btn.dataset.theme === "custom") {
      lockedTheme = null;
      customThemeInput.style.display = "inline-block";
      customThemeInput.focus();
    } else {
      lockedTheme = btn.dataset.theme;
      customThemeInput.style.display = "none";
    }
    updateThemeUI();
    renderStartIdeas(); // ✅ VIKTIG RAD
  };
});

document.getElementById("customThemeInput").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const value = e.target.value.trim();
    if (!value) return;

    lockedTheme = "custom";
    customThemeLabel = value;

    e.target.blur();
    updateThemeUI();
    renderStartIdeas(); // ✅ VIKTIG RAD
  }
});



/* =====================
   CHAT
===================== */
function addMessage(text, sender) {
  const d = document.createElement("div");
  d.className = `message ${sender}`;
  d.textContent = text;
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage(override = null) {
  const text = override || userInput.value.trim();
  if (!text) return;

  addMessage(text, "user");
  userInput.value = "";
  buttonsDiv.innerHTML = "";

  addMessage("AI tänker…", "assistant thinking");

conversation.push({
  role: "user",
  content:
    lockedTheme === "custom"
      ? `[Tema: ${customThemeLabel}] ${text}`
      : lockedTheme
        ? `[Tema: ${lockedTheme}] ${text}`
        : text
});

  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages: conversation.slice(-8) })
  });

  const data = await res.json();
  messagesDiv.lastChild.remove();
  handleAIResponse(data.message || "");
}

function handleAIResponse(raw) {
  const split = raw.indexOf("Knapp:");
  const text = split !== -1 ? raw.slice(0, split) : raw;
  const btns = (raw.match(/Knapp:\s*([^;]+);/g) || []).slice(0, 4);

  addMessage(text.trim(), "assistant");

  btns.forEach((b, i) => {
    const t = b.replace("Knapp:", "").replace(/[";]/g, "").trim();
    const btn = document.createElement("button");
    btn.textContent = `${i + 1}. ${t}`;
    btn.onclick = () => sendMessage(t);
    buttonsDiv.appendChild(btn);
  });
}

/* =====================
   RESET
===================== */
function resetConversation() {
  conversation = [];
  lockedTheme = null;
  customThemeLabel = "";
  updateThemeUI();

  messagesDiv.innerHTML = "";
  buttonsDiv.innerHTML = "";
  userInput.value = "";

  document.getElementById("chat-container").hidden = true;
  document.getElementById("start-screen").hidden = false;

  renderStartIdeas();
}

/* =====================
   START INPUT – ENTER
===================== */

const startInput = document.getElementById("startInput");
const startButton = document.getElementById("startButton");

// Klick på Starta
if (startButton) {
  startButton.addEventListener("click", e => {
    e.preventDefault();
    startFromInput();
  });
}

// Enter i start-input
if (startInput) {
  startInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      startFromInput();
    }
  });
}
/* =====================
   INIT
===================== */
renderStartIdeas();
updateThemeUI();

document.addEventListener("keydown", e => {
  // Enter skickar meddelande
  if (e.key === "Enter" && document.activeElement === userInput) {
    e.preventDefault();
    sendMessage();
    return;
  }

  // 1–4 väljer svarsknappar
  if (["1","2","3","4"].includes(e.key) && document.activeElement !== userInput) {
    const index = parseInt(e.key, 10) - 1;
    const btn = buttonsDiv.querySelector(`button:nth-child(${index + 1})`);
    if (btn) {
      btn.click();
      e.preventDefault();
    }
  }
});
</script>

</body>
</html>
