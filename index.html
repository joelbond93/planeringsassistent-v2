<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  
  <title>Planeringsassistent</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header id="header">
  <h1>Planeringsassistent</h1>

  <div id="active-theme">
    <span>Tema</span>
    <strong id="active-theme-value">Inget valt</strong>
  </div>
</header>

<div id="theme-selector" class="theme-buttons">
  <button data-theme="travel">Resor</button>
  <button data-theme="activities">Aktiviteter</button>
  <button data-theme="food">Mat</button>
  <button data-theme="projects">Projekt</button>
  <button data-theme="custom">Eget</button>
  <input id="customThemeInput" placeholder="Skriv eget tema‚Ä¶" />
</div>

<main id="main">

  <!-- START -->
  <section id="start-screen">
    <div class="start-cards" id="startIdeas"></div>
    <p class="start-or">eller skriv sj√§lv</p>

    <div class="start-input">
      <input id="startInput" placeholder="Vad vill du planera?" />
      <button id="startButton">Starta</button>
    </div>
  </section>


  <!-- CHAT -->
<section id="chat-container" hidden>
  <div id="messages"></div>

  <div id="bottom-area">
    <div id="buttons"></div>

    <div id="input-area">
      <input id="userInput" placeholder="Skriv h√§r‚Ä¶" />
      <button onclick="sendMessage()">Skicka</button>
      <button onclick="resetConversation()">Nollst√§ll</button>
    </div>
  </div>
</section>


</main>

<script>
/* =====================
   STATE
===================== */
let conversation = [];
let lockedTheme = null;
let customThemeLabel = "";     // (som vi redan identifierat)
let customStartCards = null;  // üëà H√ÑR

const messagesDiv = document.getElementById("messages");
const buttonsDiv = document.getElementById("buttons");

const customThemeInput = document.getElementById("customThemeInput"); // üëà H√ÑR

/* =====================
   THEME LABELS
===================== */
const THEME_LABELS = {
  travel: "Resor",
  activities: "Aktiviteter",
  food: "Mat",
  projects: "Projekt"
};

/* =====================
   START TOPICS
===================== */
const START_TOPICS = {
  travel: {
    quick: "Planera en resa",
    open: "Jag vill resa men vet inte vart",
    specific: "Resa utan datum eller budget"
  },
  food: {
    quick: "Planera en middag",
    open: "Vad ska vi √§ta?",
    specific: "Meny f√∂r flera dagar"
  },
  activities: {
    quick: "Hitta p√• n√•got kul",
    open: "Jag vill g√∂ra n√•got men vet inte vad",
    specific: "Aktivitet i helgen"
  },
  projects: {
    quick: "Strukturera en id√©",
    open: "Jag har f√∂r m√•nga l√∂sa tr√•dar",
    specific: "N√§sta steg i ett projekt"
  },
  default: {
    quick: "Jag vill planera n√•got",
    open: "Hj√§lp mig t√§nka",
    specific: "Ta fram n√§sta rimliga steg"
  }
};

// function pickRandom(arr, n) {
//   return arr.sort(() => Math.random() - 0.5).slice(0, n);
// }

/* =====================
   START RENDER
===================== */
function renderStartIdeas() {
  const c = document.getElementById("startIdeas");
  c.innerHTML = "";

  let cards;

  if (lockedTheme === "custom") {
    if (customStartCards === "loading") {
      cards = [
        "Skapar f√∂rslag‚Ä¶",
        "T√§nker p√• m√∂jliga ing√•ngar‚Ä¶",
        "F√∂rbereder n√§sta steg‚Ä¶"
      ];
    } else if (Array.isArray(customStartCards)) {
      cards = customStartCards;
    } else {
      const topics = START_TOPICS.default;
      cards = [topics.quick, topics.open, topics.specific];
    }
  } else {
    const topics = START_TOPICS[lockedTheme] || START_TOPICS.default;
    cards = [topics.quick, topics.open, topics.specific];
  }

  cards.forEach(text => {
    const b = document.createElement("button");
    b.innerHTML = `<strong>${text}</strong>`;

    // ‚õî disable klick under loading
    if (customStartCards === "loading") {
      b.disabled = true;
      b.style.opacity = "0.55";
      b.style.cursor = "default";
    } else {
      b.onclick = () => startConversation(text);
    }

    c.appendChild(b);
  });
}

/* =====================
   CUSTOM START CARDS (AI)
===================== */
async function generateCustomStartCards(theme) {
  const prompt = `
Skapa tre korta startf√∂rslag f√∂r planering inom temat: "${theme}".

Roller:
1. Snabb start
2. √ñppen tanke
3. Mer riktad ing√•ng

Regler:
- 4‚Äì8 ord per f√∂rslag
- inga fr√•gor
- neutralt och lugnt spr√•k
- inga emojis

Returnera exakt tre rader, utan extra text.
`;

  const res = await fetch("/api/custom-start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const data = await res.json();

  if (!Array.isArray(data.cards) || data.cards.length !== 3) {
    throw new Error("Invalid custom cards response");
  }

  return data.cards;
}

/* =====================
   START FLOW
===================== */
function startConversation(text) {
  document.getElementById("start-screen").hidden = true;
  document.getElementById("chat-container").hidden = false;
  sendMessage(text);
}
function startFromInput() {
  const input = document.getElementById("startInput");
  if (!input) return;

  const value = input.value.trim();
  if (!value) return;

  startConversation(value);
}

/* =====================
   THEME
===================== */
function updateThemeUI() {
  let label = "Inget valt";

  if (lockedTheme === "custom") {
    label = customThemeLabel || "Eget tema";
  } else if (lockedTheme && THEME_LABELS[lockedTheme]) {
    label = THEME_LABELS[lockedTheme];
  }

  document.getElementById("active-theme-value").textContent = label;

  document.body.className = lockedTheme ? `theme-${lockedTheme}` : "";

  document.querySelectorAll(".theme-buttons button").forEach(b => {
    b.classList.toggle("active", b.dataset.theme === lockedTheme);
  });
}

document.querySelectorAll(".theme-buttons button").forEach(btn => {
  btn.onclick = () => {
  if (btn.dataset.theme === "custom") {
    lockedTheme = null;
    customThemeInput.style.display = "inline-block";
    customThemeInput.focus();
  } else {
    lockedTheme = btn.dataset.theme;
    customThemeInput.style.display = "none";
    customStartCards = null; // üëà VIKTIGT
    customThemeLabel = "";
  }

  updateThemeUI();
  renderStartIdeas();
};
});

document.getElementById("customThemeInput").addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;

  // üõë skydd mot dubbel-trigger medan AI jobbar
  if (customStartCards === "loading") return;

  const value = e.target.value.trim();
  if (!value) return;

  lockedTheme = "custom";
  customThemeLabel = value;
  customStartCards = "loading"; // üëà markerar p√•g√•ende AI-jobb

  e.target.blur();
  updateThemeUI();
  renderStartIdeas(); // (kan visa placeholders senare)

  try {
    customStartCards = await generateCustomStartCards(value);
  } catch (err) {
    console.warn("Custom start cards failed", err);
    customStartCards = null;
  }

  renderStartIdeas(); // ‚úÖ rendera igen n√§r klart
});



/* =====================
   CHAT
===================== */
function addMessage(text, sender) {
  const d = document.createElement("div");
  d.className = `message ${sender}`;
  d.textContent = text;
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage(override = null) {
  const text = override || userInput.value.trim();
  if (!text) return;

  addMessage(text, "user");
  userInput.value = "";
  buttonsDiv.innerHTML = "";
  buttonsDiv.style.visibility = "hidden";

  addMessage("AI t√§nker‚Ä¶", "assistant thinking");

conversation.push({
  role: "user",
  content:
    lockedTheme === "custom"
      ? `[Tema: ${customThemeLabel}] ${text}`
      : lockedTheme
        ? `[Tema: ${lockedTheme}] ${text}`
        : text
});

  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages: conversation.slice(-8) })
  });

  const data = await res.json();
  messagesDiv.lastChild.remove();
  handleAIResponse(data.message || "");
}

function handleAIResponse(raw) {
  buttonsDiv.style.visibility = "visible"; // üëà VIKTIG RAD

  const split = raw.indexOf("Knapp:");
  const text = split !== -1 ? raw.slice(0, split) : raw;
  const btns = (raw.match(/Knapp:\s*([^;]+);/g) || []).slice(0, 4);

  addMessage(text.trim(), "assistant");

  btns.forEach((b, i) => {
    const t = b.replace("Knapp:", "").replace(/[";]/g, "").trim();
    const btn = document.createElement("button");
    btn.textContent = `${i + 1}. ${t}`;
    btn.onclick = () => sendMessage(t);
    buttonsDiv.appendChild(btn);
  });
}

/* =====================
   RESET
===================== */
function resetConversation() {
  conversation = [];
  lockedTheme = null;
  customThemeLabel = "";
  customStartCards = null; // üëà l√§gg till
  updateThemeUI();

  messagesDiv.innerHTML = "";
  buttonsDiv.innerHTML = "";
  buttonsDiv.style.visibility = "hidden";
  userInput.value = "";

  document.getElementById("chat-container").hidden = true;
  document.getElementById("start-screen").hidden = false;

  renderStartIdeas();
}

/* =====================
   START INPUT ‚Äì ENTER
===================== */

const startInput = document.getElementById("startInput");
const startButton = document.getElementById("startButton");

// Klick p√• Starta
if (startButton) {
  startButton.addEventListener("click", e => {
    e.preventDefault();
    startFromInput();
  });
}

// Enter i start-input
if (startInput) {
  startInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      startFromInput();
    }
  });
}
/* =====================
   INIT
===================== */
renderStartIdeas();
updateThemeUI();

document.addEventListener("keydown", e => {
  // Enter skickar meddelande
  if (e.key === "Enter" && document.activeElement === userInput) {
    e.preventDefault();
    sendMessage();
    return;
  }

  // 1‚Äì4 v√§ljer svarsknappar
  if (["1","2","3","4"].includes(e.key) && document.activeElement !== userInput) {
    const index = parseInt(e.key, 10) - 1;
    const btn = buttonsDiv.querySelector(`button:nth-child(${index + 1})`);
    if (btn) {
      btn.click();
      e.preventDefault();
    }
  }
});

const userInput = document.getElementById("userInput");

if (userInput && window.visualViewport) {
  let lastViewportHeight = window.visualViewport.height;

  window.visualViewport.addEventListener("resize", () => {
    const currentHeight = window.visualViewport.height;

    // Om viewport-h√∂jden minskar ‚Üí tangentbord √∂ppnas
    if (currentHeight < lastViewportHeight) {
      userInput.scrollIntoView({
        behavior: "smooth",
        block: "center"
      });
    }

    lastViewportHeight = currentHeight;
  });
}


</script>

</body>
</html>
